<img src="/assets/img/Checkout-Banner-2.jpg" width="100%">
<div class="container p-5 mt-5">

    <div class="modal fade" id="shippingaddress" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <div>
                        <img src="/assets/img/shp.jpg" width="100">
                    </div>

                    <h5 class="modal-title" id="staticBackdropLabel">Shipping Address List</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="table-responsive" style="width: 68em;border-color: blue;" id="productsJS">
                        <tbody class="table-bordered">

                            {{#each shipAddressList.address}}
                            <tr>
                                <td>
                                    <p>Name : </p>
                                    <p>Mobile : </p>
                                    <p class="text-primary">Street :</p>
                                </td>
                                <td>
                                    <p>{{this.name}}</p>
                                    <p>{{this.altermobile}}</p>
                                    <p class="text-primary">{{this.streetaddress}}</p>
                                </td>


                                <td>
                                    <p>PinCode : </p>
                                    <p>City : </p>
                                    <p class="text-primary">Landmark :</p>
                                </td>
                                <td>
                                    <p>{{this.pincode}}</p>
                                    <p>{{this.city}}</p>
                                    <p class="text-primary">{{this.landmark}}</p>
                                </td>

                                <td>
                                    <p>District :</p>
                                    <p>State :</p>
                                </td>
                                <td>
                                    <p>{{this.district}}</p>
                                    <p>{{this.state}}</p>
                                </td>
                                <td>

                                    <button onclick="editShipAddress('{{this._id}}',this,false)"
                                        class="btn btn-success">
                                        Select</button>
                                    {{!-- <button class="btn btn-outline-danger border-0"
                                        onclick="delShippAddress('{{this._id}}',this)"><i
                                            class="fa-solid fa-trash"></i></button> --}}
                                </td>
                            </tr>
                            {{/each}}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal -->
    <form action="/checkout" method="post" id="checkout-form">
        <div class="row ">
            <div class="col-lg-6 col-xl-6  bg-light  checkout">
                <br>
                <h5>Enter Delivery Details</h5><br>
                <div>
                    <a href="" data-bs-toggle="modal" data-bs-target="#shippingaddress">Click here</a>
                    <p> to show address list.</p>
                </div>


                <div class="row editColor textMuted">

                    {{#if (neq address "0")}}
                    <div class="col">
                        {{#each address}}

                        <label>Name</label>
                        <input type="text" class="form-control " id="shipname" name="name"
                            value="{{this.deliveryDetails.name}}" placeholder=""><br>

                        <label>Street</label>
                        <input type="text" class="form-control" id="streetaddress" name="streetaddress"
                            value="{{this.deliveryDetails.street}}" placeholder=""><br>

                        <label>Mobile</label>
                        <input type="text" class="form-control " id="altermobile" name="altermobile"
                            value="{{this.deliveryDetails.mobile}}" placeholder=""><br>

                        <label>Pincode</label>
                        <input type="number" class="form-control" id="pincode" name="pincode"
                            value="{{this.deliveryDetails.pin}}" placeholder=""><br>
                    </div>
                    <div class="col">

                        <label>Landmark</label>
                        <input type="text" class="form-control" name="landmark" id="landmark"
                            value="{{this.deliveryDetails.landmark}}" placeholder=""><br>

                        <label>City</label>
                        <input type="text" class="form-control" id="city" name="city"
                            value="{{this.deliveryDetails.city}}" placeholder=""><br>

                        <label>District</label>
                        <input type="text" class="form-control" id="district" name="district"
                            value="{{this.deliveryDetails.district}}" placeholder=""><br>

                        <label>State</label>
                        <input type="text" class="form-control" name="state" id="state"
                            value="{{this.deliveryDetails.state}}" placeholder=""><br>
                    </div>

                    {{/each}}
                    {{else}}
                    <div class="col">
                        <label>Name</label>
                        <input type="text" class="form-control " id="shipname" name="name" value="" placeholder=""><br>

                        <label>Street</label>
                        <input type="text" class="form-control" id="streetaddress" name="streetaddress" value=""
                            placeholder=""><br>

                        <label>Mobile</label>
                        <input type="text" class="form-control " id="altermobile" name="altermobile" value=""
                            placeholder=""><br>

                        <label>Pincode</label>
                        <input type="number" class="form-control" id="pincode" name="pincode" value=""
                            placeholder=""><br>
                    </div>
                    <div class="col">

                        <label>Landmark</label>
                        <input type="text" class="form-control" name="landmark" id="landmark" value=""
                            placeholder=""><br>

                        <label>City</label>
                        <input type="text" class="form-control" id="city" name="city" value="" placeholder=""><br>

                        <label>District</label>
                        <input type="text" class="form-control" id="district" name="district" value=""
                            placeholder=""><br>

                        <label>State</label>
                        <input type="text" class="form-control" name="state" id="state" value="" placeholder=""><br>
                    </div>
                    {{/if}}
                </div>
            </div>
            
            <div class="col-lg-6 col-xl-6 p-5 ">
                <input type="text" value="{{coupen.coupencode}}" name="coupencode" hidden>
                <input type="text" value="{{id}}" name="proid" hidden>

                {{!-- <div class="row "> --}}
                    <div class="mt-2 ">
                        <img src="/assets/img/payment-gateway-integration.jpg" alt="img" width="430px">
                    </div>

                    {{!--style="border-style:dashed;" --}}

                    <h5>Total amount: Rs. <span style="color: blue;font-size: x-large;">{{total}}/-</span></h5>
                    <hr>
                    <p>Payment Method</p>

                    <label>
                        <input type="radio" name="payment-method" value="Online">
                        Card Payment
                    </label>
                    <br>
                    <label>
                        <input type="radio" name="payment-method" value="COD" checked>
                        COD
                    </label><br>

                    <button type="submit" class="btn btn-outline-success border-0" style="float: right;">Checkout<i
                            class="fa-solid fa-thumbs-up"></i></button>


                    {{!--
                </div> --}}

            </div>
        </div>
    </form>
</div>

<script>




    $("#checkout-form").submit((e) => {
        e.preventDefault(),

            $.ajax({
                url: '/checkout',
                method: 'post',
                data: $('#checkout-form').serialize(),
                success: (response) => {
                    if (response.codSuccess) {
                        location.href = '/order'
                    }
                    else {
                        razorPayPayment(response)
                    }
                }
            })
    })

    function razorPayPayment(order) {

        var options = {
            "key": "rzp_test_uEAmKKJZmehl2V", // Enter the Key ID generated from the Dashboard
            "amount": order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
            //alert("**********************************"+order),
            "currency": "INR",
            "name": "SHB Online Hub",
            "description": "Test Transaction",
            "image": "https://example.com/your_logo",
            "order_id": order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
            "handler": function (response) {
                //alert(response.razorpay_payment_id);
                //alert(response.razorpay_order_id);
                //alert(response.razorpay_signature)

                verifyPayment(response, order)
            },
            "prefill": {
                "name": "Shuhaib",
                "email": "shshuaib99@gmail.com",
                "contact": "9746182666"
            },
            "notes": {
                "address": "Razorpay Corporate Office"
            },
            "theme": {
                "color": "#3399cc"
            }

        };
        var rzp1 = new Razorpay(options);
        rzp1.open();
    }

    function verifyPayment(payment, order) {
        $.ajax({
            url: '/verify-payment',
            data: {
                payment,
                order
            },
            method: 'post',
            success: (response) => {
                if (response.status) {
                    location.href = '/order'
                }
                else {
                    alert("Payment failed")
                }

            }

        })
    }

    //................validation..................
    $(document).ready(function () {
        $("#checkout-form").validate({
            rules: {
                name: {
                    required: true,
                    lettersonly: true
                },

                mobile: {
                    required: true
                },
                city: {
                    required: true
                },
                pin: {
                    required: true,
                    digits: true
                },
                address: {
                    required: true
                }
            }
        })

    })

</script>